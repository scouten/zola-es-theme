{% set poster = poster | default(value="") %}
{% set controls = controls | default(value=true) %}
{% set autoplay = autoplay | default(value=false) %}
{% set muted = muted | default(value=false) %}
{% set loop = loop | default(value=false) %}
{% set preload = preload | default(value="metadata") %}

{# Construct HLS master playlist URL from cdn_key #}
{% set hls_src = "https://img.ericscouten.com/" ~ cdn_key ~ "/hls/master.m3u8" %}

{# If no poster provided, try default poster.jpg location #}
{% if not poster %}
  {% set poster = "https://img.ericscouten.com/" ~ cdn_key ~ "/poster.jpg" %}
{% endif %}

<div class="es_video anti-section">
  <video
    id="{{ id }}"
    class="video-js vjs-default-skin vjs-fluid"
    {% if controls %}controls{% endif %}
    {% if autoplay %}autoplay{% endif %}
    {% if muted %}muted{% endif %}
    {% if loop %}loop{% endif %}
    preload="{{ preload }}"
    playsinline
    poster="{{ poster }}"
  >
    <source src="{{ hls_src }}" type="application/x-mpegURL" />
  </video>
  {% if caption or title or creator -%}
  <div class="caption">
    {% if title -%}
      <span class="caption-title">{{ title }} </span>
      {% if caption or creator %} &middot; {% endif -%}
    {% endif -%}
    {% if caption -%}{{ caption }}{% endif -%}
    {% if creator -%}
      {% if title or caption %} &middot; {% endif -%}
      by {{ creator }}
    {% endif -%}
  </div>
  {%- endif -%}
</div>

{# Initialize Video.js #}
<script>
  (function () {
    var initPlayer = function() {
      var player = window.videojs(document.getElementById({{ id | json_encode() | safe }}), {
        fluid: true,
        responsive: true
      });
    };
    
    if (window.videojs) {
      initPlayer();
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        var checkVideojs = setInterval(function() {
          if (window.videojs) {
            clearInterval(checkVideojs);
            initPlayer();
          }
        }, 50);
      });
    }
  })();
</script>
