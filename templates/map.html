{%- if page.extra.markers or page.extra.track or page.extra.track_log_key or page.extra.lat or page.extra.lon -%}
<div id="map"{%- if config.extra.is_dark %} class="map-dark-mode"{%- endif %}></div>

{%- if page.extra.markers -%}
<script src="/common/add-gps-markers.js"></script>
{%- if config.extra.map_clustering -%}
<script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
{%- endif -%}
<script src="{{ page.extra.markers }}"></script>
{%- endif -%}
<script>
  let map;

  function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      {%- if not page.extra.bounds -%}
        {%- if page.extra.zoom -%}
        zoom: {{ page.extra.zoom }},
        {%- else -%}
        zoom: 12,
        {%- endif -%}
      {%- endif -%}
      {%- if page.extra.lat and page.extra.lon -%}
      center: { lat: {{ page.extra.lat }}, lng: {{ page.extra.lon }} },
      {%- endif -%}
      mapTypeId: "terrain",
      {%- if config.extra.is_dark -%}
      styles: [
        { elementType: "geometry", stylers: [{ color: "#363640" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
        {
          featureType: "administrative.country",
          elementType: "geometry.stroke",
          stylers: [{ "color": "#999999" }],
        },
        {
          featureType: "administrative.province",
          elementType: "geometry.stroke",
          stylers: [{ color: "#cccccc" }],
        },
        {
          featureType: "administrative.locality",
          elementType: "labels.text.fill",
          stylers: [{ color: "#d59563" }],
        },
        {
          featureType: "poi",
          elementType: "labels.text.fill",
          stylers: [{ color: "#d59563" }],
        },
        {
          featureType: "poi.park",
          elementType: "geometry",
          stylers: [{ color: "#263c3f" }],
        },
        {
          featureType: "poi.park",
          elementType: "labels.text.fill",
          stylers: [{ color: "#6b9a76" }],
        },
        {
          featureType: "road",
          elementType: "geometry",
          stylers: [{ color: "#38414e" }],
        },
        {
          featureType: "road",
          elementType: "geometry.stroke",
          stylers: [{ color: "#212a37" }],
        },
        {
          featureType: "road",
          elementType: "labels.text.fill",
          stylers: [{ color: "#9ca5b3" }],
        },
        {
          featureType: "road.highway",
          elementType: "geometry",
          stylers: [{ color: "#746855" }],
        },
        {
          featureType: "road.highway",
          elementType: "geometry.stroke",
          stylers: [{ color: "#1f2835" }],
        },
        {
          featureType: "road.highway",
          elementType: "labels.text.fill",
          stylers: [{ color: "#f3d19c" }],
        },
        {
          featureType: "transit",
          elementType: "geometry",
          stylers: [{ color: "#2f3948" }],
        },
        {
          featureType: "transit.station",
          elementType: "labels.text.fill",
          stylers: [{ color: "#d59563" }],
        },
        {
          featureType: "water",
          elementType: "geometry",
          stylers: [{ color: "#17263c" }],
        },
        {
          featureType: "water",
          elementType: "labels.text.fill",
          stylers: [{ color: "#515c6d" }],
        },
        {
          featureType: "water",
          elementType: "labels.text.stroke",
          stylers: [{ color: "#17263c" }],
        },
      ],
      {%- endif -%}

    });

    map.setOptions('TERRAIN');

    {%- if page.extra.bounds -%}
    const sw = new google.maps.LatLng({{ page.extra.bounds.sw[0] }}, {{ page.extra.bounds.sw[1] }});
    const ne = new google.maps.LatLng({{ page.extra.bounds.ne[0] }}, {{ page.extra.bounds.ne[1] }});
    const bounds = new google.maps.LatLngBounds(sw, ne);
    map.fitBounds(bounds);
    {%- endif -%}

    {%- if page.extra.track or page.extra.track_log_key -%}
    var kmlLayer = new google.maps.KmlLayer({
      {%- if config.extra.kml_folder -%}
      url: '{{config.base_url | safe }}/kml/{{ page.extra.track }}',
      {%- elif page.extra.track_log_key -%}
      url: 'https://img.ericscouten.com/{{ page.extra.track_log_key | safe }}',
      {%- else -%}
      url: '{{config.base_url | safe }}{{ current_path | safe }}{{ page.extra.track }}',
      {%- endif -%}
      preserveViewport: true,
      map: map
    });
    google.maps.event.addListener(kmlLayer, 'status_changed', function(evt) {
      console.log("KML layer status: " + kmlLayer.getStatus());
    });
    {%- endif -%}

    {%- if page.extra.markers -%}
    markers = addGpxMarkers(map);
    {%- if config.extra.map_clustering -%}
    const markerCluster = new MarkerClusterer(map, markers,
      {
        imagePath: "{{ config.base_url | safe }}/common/m",
        maxZoom: 16,
      } );
    {%- endif -%}
    {%- elif page.extra.lat and page.extra.lon -%}
    const marker = new google.maps.Marker({
      position: { lat: {{ page.extra.lat }}, lng: {{ page.extra.lon }} },
      map: map,
      preserveViewport: false,
    });
    {%- endif -%}
  }
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ get_env(name="GOOGLE_API_KEY", default="none") }}&callback=initMap&libraries=&v=weekly"
  async>
</script>
{%- if page.extra.route or page.extra.distance -%}
  <div class="map-caption">
    {%- if page.extra.route -%}{{ page.extra.route }}{%- endif -%}
    {%- if page.extra.route and page.extra.distance -%}&nbsp;Â· {% endif -%}
    {%- if page.extra.distance -%}{{ page.extra.distance }}{%- endif -%}
    {%- if page.extra.markers -%}
    <br/>
    (Mouse over or tap on the markers to see the photos there.)
    {%- endif -%}
  </div>
{%- endif -%}
{%- endif -%}
